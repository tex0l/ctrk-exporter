# CTRK Parser

A Python parser for Yamaha Y-Trac motorcycle telemetry files (.CTRK).

## What is CTRK?

CTRK files are proprietary binary telemetry files generated by the Yamaha Y-Trac data logging system used on motorcycles. They contain GPS coordinates, CAN bus data (engine telemetry, IMU, brakes, etc.), and lap timing information recorded at 10 Hz.

## Features

- Pure Python implementation with no external dependencies
- Extracts 21 telemetry channels from CAN bus data
- GPS position and speed from NMEA sentences
- Automatic lap detection via finish line crossing
- CSV export for analysis in any spreadsheet or data tool
- Optional graph generation (requires matplotlib)

## Installation

```bash
git clone https://github.com/tex0l/ctrk-exporter.git
cd ctrk-exporter

# Optional: for graph generation
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

## Quick Start

```bash
# Parse a single file
./ctrk-exporter parse session.CTRK

# Parse multiple files
./ctrk-exporter parse *.CTRK

# Output to a specific directory
./ctrk-exporter parse session.CTRK -o results/
```

## CLI Reference

### Parse Command

Converts CTRK files to CSV format.

```bash
./ctrk-exporter parse <file.CTRK>... [options]
```

**Options:**
- `-o, --output <dir>` — Output directory (default: `output/<timestamp>/`)
- `--raw` — Also export raw uncalibrated values
- `--native` — Use native-compatible per-lap processing mode

**Examples:**

```bash
# Basic parsing
./ctrk-exporter parse session.CTRK

# Parse all CTRK files in current directory
./ctrk-exporter parse *.CTRK

# Export to custom directory with raw values
./ctrk-exporter parse session.CTRK -o my_data/ --raw
```

### Graph Command

Generates visualization graphs from parsed CSV files. Requires virtual environment with matplotlib.

```bash
source .venv/bin/activate
./ctrk-exporter graph <file.csv> [options]
```

**Options:**
- `-l, --lap <number>` — Generate graph for specific lap only
- `-o, --output <dir>` — Output directory for PNG files

**Examples:**

```bash
# Generate graphs for all laps
./ctrk-exporter graph output/2026-01-26_21-30-00/session_parsed.csv

# Generate graph for lap 3 only
./ctrk-exporter graph session_parsed.csv -l 3
```

### Android Command (Advanced)

Uses the official native library via Android emulator for reference output.

> **Platform:** macOS ARM (Apple Silicon) only
>
> **Note:** Requires manual APK download and Android SDK setup

```bash
./ctrk-exporter android setup      # Extract .so from APK, build app
./ctrk-exporter android convert <file.CTRK>
./ctrk-exporter android clean      # Clean build artifacts
```

See [APK Analysis documentation](apk_analysis/README.md) for setup details.

## Output Format

Each run creates a timestamped subdirectory:

```
output/
└── 2026-01-26_21-30-00/
    ├── session_parsed.csv
    └── session_parsed_graphs/
        ├── lap1.png
        ├── lap2.png
        └── ...
```

### CSV Columns

| Column | Description | Unit |
|--------|-------------|------|
| lap | Lap number | — |
| time_ms | Unix timestamp | ms |
| latitude | GPS latitude | degrees |
| longitude | GPS longitude | degrees |
| gps_speed_kmh | GPS ground speed | km/h |
| rpm | Engine RPM | RPM |
| throttle_grip | Accelerator position (APS) | % |
| throttle | Throttle valve position (TPS) | % |
| water_temp | Coolant temperature | °C |
| intake_temp | Intake air temperature | °C |
| front_speed_kmh | Front wheel speed | km/h |
| rear_speed_kmh | Rear wheel speed | km/h |
| fuel_cc | Cumulative fuel consumption (per lap) | cc |
| lean_deg | Lean angle (absolute) | ° |
| lean_signed_deg | Lean angle with direction | ° |
| pitch_deg_s | Pitch rate | °/s |
| acc_x_g | Longitudinal acceleration | G |
| acc_y_g | Lateral acceleration | G |
| front_brake_bar | Front brake pressure | bar |
| rear_brake_bar | Rear brake pressure | bar |
| gear | Current gear (0=N, 1-6) | — |
| f_abs | Front ABS active | bool |
| r_abs | Rear ABS active | bool |
| tcs | Traction Control active | bool |
| scs | Slide Control active | bool |
| lif | Lift Control active | bool |
| launch | Launch Control active | bool |

## Project Structure

```
ctrk-exporter/
├── ctrk-exporter              # CLI entry point
├── src/
│   ├── ctrk_parser.py         # Core parser
│   ├── visualize_all_channels.py  # Graph generation
│   └── test_parser_comparison.py  # Validation suite
├── android_app/               # Android converter app
├── apk_analysis/              # APK extraction tools
├── docs/
│   ├── CTRK_FORMAT_SPECIFICATION.md  # Binary format specification
│   ├── NATIVE_LIBRARY.md             # Native library analysis
│   ├── COMPARISON.md                 # Parser validation report
│   └── product/                      # Product backlog
└── output/                    # Generated files (gitignored)
```

## Documentation

- **[CTRK Format Specification](docs/CTRK_FORMAT_SPECIFICATION.md)** — Complete binary file format documentation
- **[Native Library Analysis](docs/NATIVE_LIBRARY.md)** — Reverse engineering notes for `libSensorsRecordIF.so`
- **[Comparison Report](docs/COMPARISON.md)** — Validation against native library output

## Backstory

I'm not a motorcyclist. A friend told me he had tried to extract data from his CTRK files without success. I said it would be easy with Claude. It became a matter of principle.

The truth is: it took 23% of my weekly Claude Max quota, but I got it done in 48 hours.

## License

MIT License

## Acknowledgments

- File format reverse-engineered from the official Y-Trac application
- Calibration formulas verified using radare2 disassembly of the native library
- Heavily assisted by [Claude Code](https://claude.ai/code)
