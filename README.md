# CTRK Parser

Two implementations for parsing Yamaha Y-Trac telemetry files (.CTRK):

1. **Python parser** - Pure Python, no dependencies, works everywhere
2. **Native converter** - Uses the official Y-Trac library via Android emulator (100% accuracy)

## What is CTRK?

CTRK files are proprietary binary telemetry files generated by the Yamaha Y-Trac data logging system used on motorcycles. They contain GPS coordinates, CAN bus data (engine telemetry, IMU, brakes, etc.), and lap timing information.

## Two Implementations

### Python Parser (Recommended)

A reverse-engineered pure Python implementation with no external dependencies. Validated against the native library across 47 files and 420K+ telemetry records.

**Pros:**
- Works on any platform (macOS, Linux, Windows)
- No Android SDK or emulator required
- Fast and lightweight
- 94.9% match rate vs native library (22 channels, 47 files)
- Better data quality at lap boundaries (no physically impossible values)

**Cons:**
- ~17% RPM mismatch due to emission grid phase divergence (correct values, slightly different timestamps)
- Minor record count differences (~1% orphan records on each side)

```bash
./ctrk-exporter parse session.CTRK
./ctrk-exporter parse session.CTRK --native  # Per-lap mode (95.6% match)
```

### Native Converter

Uses the official `libSensorsRecordIF.so` library from the Y-Trac Android app, running on an Android emulator.

**Pros:**
- 100% identical output to the official Y-Trac app
- Guaranteed accuracy

**Cons:**
- Requires Android SDK and emulator
- macOS ARM (Apple Silicon) only
- Slower (needs to boot emulator, transfer files)
- Produces physically impossible values at lap boundaries (-7G, -90°, -300°/s)

```bash
./ctrk-exporter android setup
./ctrk-exporter android convert session.CTRK
```

### Validation Summary

Benchmarked across 42 file pairs (420K+ aligned records):

| Channel | Match Rate | Notes |
|---------|-----------|-------|
| Boolean channels (f_abs, r_abs, tcs, scs, lif, launch) | 99.6-100% | Near-perfect |
| gear | 99.8% | |
| water_temp, intake_temp | 99.4-99.8% | |
| gps_speed_kmh | 97.4% | |
| front_brake_bar | 96.4% | |
| throttle, throttle_grip | 93.9-94.5% | |
| lean_deg, acc_x_g, acc_y_g | 89.2-91.5% | Emission grid phase shift |
| rpm | 83.0% | Architectural ceiling (single-pass vs per-lap) |
| **Overall** | **94.9%** | **9.2M channel comparisons** |

The `--native` per-lap mode reaches **95.6%** overall by replicating the native per-lap architecture, with fuel_cc improving from 86.5% to 98.7%.

## Installation

```bash
git clone https://github.com/tex0l/ctrk-exporter.git
cd ctrk-exporter

# Optional: for graph generation
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

## CLI Usage

### Parse (Python)

```bash
./ctrk-exporter parse session.CTRK                  # Single file
./ctrk-exporter parse *.CTRK                         # Batch all files
./ctrk-exporter parse session.CTRK -o results/       # Output to specific directory
./ctrk-exporter parse session.CTRK --raw             # Also export raw uncalibrated values
./ctrk-exporter parse session.CTRK --native          # Native-compatible per-lap mode
```

### Generate Graphs

Requires venv activation:

```bash
source .venv/bin/activate
./ctrk-exporter graph output/<timestamp>/session_parsed.csv       # All laps
./ctrk-exporter graph output/<timestamp>/session_parsed.csv -l 3  # Lap 3 only
```

### Android Converter

> **Platform:** macOS ARM (Apple Silicon) only
>
> **Tested with:** Y-Trac version 1.3.8
>
> **Requires:** Manual APK download from [APKPure](https://apkpure.com/y-trac/com.yamaha.jp.dataviewer) or [APKMirror](https://www.apkmirror.com/?s=y-trac)

```bash
./ctrk-exporter android setup                     # Extract .so from APK, build app
./ctrk-exporter android convert session.CTRK      # Convert file
./ctrk-exporter android clean                     # Clean build artifacts
```

## Telemetry Channels (21)

### Analog Channels (15)

| Column | Description | Unit | Formula |
|--------|-------------|------|---------|
| rpm | Engine RPM | RPM | raw / 2.56 |
| throttle_grip | Throttle grip position (APS) | % | ((raw / 8.192) × 100) / 84.96 |
| throttle | Throttle valve position (TPS) | % | ((raw / 8.192) × 100) / 84.96 |
| front_speed_kmh | Front wheel speed | km/h | (raw / 64.0) × 3.6 |
| rear_speed_kmh | Rear wheel speed | km/h | (raw / 64.0) × 3.6 |
| gear | Gear position | 0-6 | direct |
| lean_deg | Lean angle (absolute) | ° | (raw / 100.0) - 90.0 |
| pitch_deg_s | Pitch rate | °/s | (raw / 100.0) - 300.0 |
| front_brake_bar | Front brake pressure | bar | raw / 32.0 |
| rear_brake_bar | Rear brake pressure | bar | raw / 32.0 |
| water_temp | Coolant temperature | °C | (raw / 1.6) - 30.0 |
| intake_temp | Intake air temperature | °C | (raw / 1.6) - 30.0 |
| fuel_cc | Cumulative fuel consumption | cc | raw / 100.0 |
| acc_x_g | Longitudinal acceleration | G | (raw / 1000.0) - 7.0 |
| acc_y_g | Lateral acceleration | G | (raw / 1000.0) - 7.0 |

### Boolean Channels (6)

| Column | Description |
|--------|-------------|
| f_abs | Front ABS active |
| r_abs | Rear ABS active |
| tcs | Traction Control System active |
| scs | Slide Control System active |
| lif | Lift Control active |
| launch | Launch Control active |

### GPS Data

| Column | Description | Unit |
|--------|-------------|------|
| lap | Lap number | - |
| time_ms | Timestamp | ms |
| latitude | GPS latitude | degrees |
| longitude | GPS longitude | degrees |
| gps_speed_kmh | GPS speed | km/h |

### Derived Fields (Python parser only)

| Column | Description | Unit | Note |
|--------|-------------|------|------|
| lean_signed_deg | Lean angle with direction | ° | Same CAN 0x0258 data as lean_deg, but preserves the sign (negative/positive) instead of taking the absolute value. Not present in native library output. |

## Output Structure

Each run creates a timestamped subdirectory:

```
output/
└── 2026-01-26_21-30-00/
    ├── session_parsed.csv
    └── session_parsed_graphs/
        ├── lap1.png
        ├── lap2.png
        └── ...
```

## Project Structure

```
ctrk-exporter/
├── ctrk-exporter              # CLI entry point
├── src/
│   ├── ctrk_parser.py         # Python parser (1048 lines, no dependencies)
│   ├── visualize_all_channels.py  # Graph generation
│   └── test_parser_comparison.py  # QA benchmark: Python vs Native
├── android_app/               # Android converter app
├── apk_analysis/              # APK extraction tools
├── docs/
│   ├── CTRK_FORMAT_SPECIFICATION.md  # Binary format spec (v2.1)
│   ├── NATIVE_LIBRARY.md            # Reverse engineering notes
│   ├── REVIEW_REPORT.md             # Validation report and match rates
│   └── product/                     # Product backlog and epics
└── output/                    # Generated files (gitignored)
```

## Documentation

- **[CTRK Format Specification](docs/CTRK_FORMAT_SPECIFICATION.md)** - Complete binary file format (v2.1), validated by disassembly and hex dump analysis
- **[Native Library Analysis](docs/NATIVE_LIBRARY.md)** - Reverse engineering notes for `libSensorsRecordIF.so`
- **[Review Report](docs/REVIEW_REPORT.md)** - Spec verification matrix, parser compliance, match rates
- **[Product Backlog](docs/product/BACKLOG.md)** - Prioritized feature roadmap

## Backstory

I'm not a motorcyclist. A friend told me he had tried to extract data from his CTRK files without success. I said it would be easy with Claude. It became a matter of principle.

The truth is: it took 23% of my weekly Claude Max quota, but I got it done in 48 hours.

## License

MIT License

## Acknowledgments

- File format reverse-engineered from the official Y-Trac application
- Calibration formulas verified using radare2 disassembly of the native library
- Heavily assisted by [Claude Code](https://claude.ai/code)
