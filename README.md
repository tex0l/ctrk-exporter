# CTRK Parser

Two implementations for parsing Yamaha Y-Trac telemetry files (.CTRK/.CCT):

1. **Python parser** - Pure Python, no dependencies, works everywhere
2. **Native converter** - Uses the official Y-Trac library via Android emulator (100% accuracy)

## What is CTRK?

CTRK files are proprietary binary telemetry files generated by the Yamaha Y-Trac data logging system used on motorcycles. They contain GPS coordinates, CAN bus data (engine telemetry, IMU, brakes, etc.), and lap timing information.

## Two Implementations

### Python Parser (Recommended)

A reverse-engineered pure Python implementation with no external dependencies.

**Pros:**
- Works on any platform (macOS, Linux, Windows)
- No Android SDK or emulator required
- Fast and lightweight

**Cons:**
- ~0.08% more data points than native
- Minor timestamp smoothing differences (~10-15ms)

```bash
./ctrk-exporter parse session.CTRK
```

### Native Converter

Uses the official `libSensorsRecordIF.so` library from the Y-Trac Android app, running on an Android emulator.

**Pros:**
- 100% identical output to the official Y-Trac app
- Guaranteed accuracy

**Cons:**
- Requires Android SDK and emulator
- macOS ARM (Apple Silicon) only
- Slower (needs to boot emulator, transfer files)

```bash
./ctrk-exporter android setup
./ctrk-exporter android convert session.CTRK
```

### Known Differences

| Aspect | Python Parser | Native Converter |
|--------|---------------|------------------|
| Data points | ~0.08% more | Reference |
| Timestamp intervals | 100% at 100ms | ~98% at 100ms |
| LEAN angle | ~0.1% difference | Reference |
| Timestamp smoothing | None | ~10-15ms smoothing |

The Python parser produces slightly more data points because it includes valid GPS records that the native library filters out for undocumented reasons (likely interpolation logic).

## Installation

```bash
git clone https://github.com/tex0l/ctrk-exporter.git
cd ctrk-exporter

# Optional: for graph generation
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

## CLI Usage

### Parse (Python)

```bash
./ctrk-exporter parse session.CTRK                # Output to output/<timestamp>/
./ctrk-exporter parse session.CTRK -o result.csv  # Specific output file
./ctrk-exporter parse session.CTRK --raw          # Also export raw values
```

### Generate Graphs

```bash
./ctrk-exporter graph output/<timestamp>/session_parsed.csv       # All laps
./ctrk-exporter graph output/<timestamp>/session_parsed.csv -l 3  # Lap 3 only
```

### Android Converter

> **Platform:** macOS ARM (Apple Silicon) only
>
> **Tested with:** Y-Trac version 1.3.8

```bash
./ctrk-exporter android setup                     # Download APK, build app
./ctrk-exporter android convert session.CTRK      # Convert file
./ctrk-exporter android clean                     # Clean build artifacts
```

## Telemetry Channels (21)

### Analog Channels (15)

| Column | Description | Unit | Formula |
|--------|-------------|------|---------|
| rpm | Engine RPM | RPM | raw / 2.56 |
| throttle_grip | Throttle grip position (APS) | % | ((raw / 8.192) × 100) / 84.96 |
| throttle | Throttle valve position (TPS) | % | ((raw / 8.192) × 100) / 84.96 |
| front_speed_kmh | Front wheel speed | km/h | (raw / 64.0) × 3.6 |
| rear_speed_kmh | Rear wheel speed | km/h | (raw / 64.0) × 3.6 |
| gear | Gear position | 0-6 | direct |
| lean_deg | Lean angle | ° | (raw / 100.0) - 90.0 |
| pitch_deg_s | Pitch rate | °/s | (raw / 100.0) - 300.0 |
| front_brake_bar | Front brake pressure | bar | raw / 32.0 |
| rear_brake_bar | Rear brake pressure | bar | raw / 32.0 |
| water_temp | Coolant temperature | °C | (raw / 1.6) - 30.0 |
| intake_temp | Intake air temperature | °C | (raw / 1.6) - 30.0 |
| fuel_cc | Cumulative fuel consumption | cc | raw / 100.0 |
| acc_x_g | Lateral acceleration | G | (raw / 1000.0) - 7.0 |
| acc_y_g | Longitudinal acceleration | G | (raw / 1000.0) - 7.0 |

### Boolean Channels (6)

| Column | Description |
|--------|-------------|
| f_abs | Front ABS active |
| r_abs | Rear ABS active |
| tcs | Traction Control System active |
| scs | Slide Control System active |
| lif | Lift Control active |
| launch | Launch Control active |

### GPS Data

| Column | Description | Unit |
|--------|-------------|------|
| lap | Lap number | - |
| time_ms | Timestamp | ms |
| latitude | GPS latitude | degrees |
| longitude | GPS longitude | degrees |
| gps_speed_kmh | GPS speed | km/h |

## Output Structure

Each run creates a timestamped subdirectory:

```
output/
└── 2026-01-26_21-30-00/
    ├── session_parsed.csv
    └── session_parsed_graphs/
        ├── lap1.png
        ├── lap2.png
        └── ...
```

## Project Structure

```
ctrk-exporter/
├── ctrk-exporter              # CLI entry point
├── src/
│   ├── ctrk_parser.py         # Python parser (no dependencies)
│   └── visualize_all_channels.py
├── android_app/               # Android converter app
├── apk_analysis/              # APK extraction tools
├── docs/
│   ├── CTRK_FORMAT_SPECIFICATION.md
│   └── NATIVE_LIBRARY.md
└── output/                    # Generated files (gitignored)
```

## Documentation

- **[CTRK Format Specification](docs/CTRK_FORMAT_SPECIFICATION.md)** - Complete binary file format
- **[Native Library Analysis](docs/NATIVE_LIBRARY.md)** - Reverse engineering notes

## Backstory

I'm not a motorcyclist. A friend told me he had tried to extract data from his CTRK files without success. I said it would be easy with Claude. It became a matter of principle.

The truth is: it took 23% of my weekly Claude Max quota, but I got it done in 48 hours.

## License

MIT License

## Acknowledgments

- File format reverse-engineered from the official Y-Trac application
- Calibration formulas verified using radare2 disassembly of the native library
- Heavily assisted by [Claude Code](https://claude.ai/code)
