# CTRK Parser

Pure Python parser for Yamaha Y-Trac telemetry files (.CTRK/.CCT), with verified accuracy against the official native library.

## What is CTRK?

CTRK files are proprietary binary telemetry files generated by the Yamaha Y-Trac data logging system used on motorcycles. They contain GPS coordinates, CAN bus data (engine telemetry, IMU, brakes, etc.), and lap timing information.

## Features

- **Pure Python parser** - No external dependencies for parsing
- **15 telemetry channels** - All major channels supported
- **Verified accuracy** - Calibration formulas verified against native library output
- **Lap detection** - Automatic lap splitting based on start/finish line crossing
- **CLI tool** - Easy command-line interface for parsing and Android conversion
- **Android converter** - Use the official native library via an Android app

## Installation

```bash
git clone https://github.com/your-username/ctrk-parser.git
cd ctrk-parser

# Create virtual environment (optional, for visualization scripts)
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

## CLI Usage

### Parse a CTRK file (Python parser)

```bash
# Basic parsing - output to output/<name>_parsed.csv
./ctrk-exporter parse session.CTRK

# Specify output file
./ctrk-exporter parse session.CTRK -o result.csv

# Also export raw (uncalibrated) values
./ctrk-exporter parse session.CTRK --raw
```

### Android converter (uses official native library)

The Android converter uses the official `libSensorsRecordIF.so` native library from Y-Trac for 100% accurate parsing.

> **Tested with Y-Trac version 1.3.8**

```bash
# Step 1: Setup (download APK manually first, then run)
./ctrk-exporter android setup

# Step 2: Convert a file
./ctrk-exporter android convert session.CTRK

# Optional: specify output
./ctrk-exporter android convert session.CTRK -o native_output.csv

# Clean build artifacts
./ctrk-exporter android clean
```

#### Android Setup Details

1. Run `./ctrk-exporter android setup`
2. The CLI will prompt you to download the APK automatically or manually
3. After obtaining the APK, the setup will:
   - Extract the native library from the APK
   - Inject it into the Android app
   - Build the converter app
   - Install it on your emulator/device
4. Start an Android emulator if not already running:
   ```bash
   emulator -list-avds
   emulator -avd <avd_name> &
   ```

## Output Format

The parser exports CSV files with the following columns:

| Column | Description | Unit |
|--------|-------------|------|
| lap | Lap number | - |
| time_ms | Timestamp | ms |
| latitude, longitude | GPS coordinates | degrees |
| gps_speed_kmh | GPS speed | km/h |
| rpm | Engine RPM | RPM |
| throttle_grip | Throttle grip position | % |
| throttle | Throttle valve position | % |
| water_temp | Coolant temperature | °C |
| intake_temp | Intake air temperature | °C |
| front_speed_kmh | Front wheel speed | km/h |
| rear_speed_kmh | Rear wheel speed | km/h |
| fuel_cc | Cumulative fuel consumption | cc |
| lean_deg | Lean angle | degrees |
| pitch_deg_s | Pitch rate | °/s |
| acc_x_g | Lateral acceleration | G |
| acc_y_g | Longitudinal acceleration | G |
| front_brake_bar | Front brake pressure | bar |
| rear_brake_bar | Rear brake pressure | bar |
| gear | Gear position | 0-6 |

## Project Structure

```
ctrk-parser/
├── ctrk-exporter           # CLI entry point
├── src/
│   ├── ctrk_parser.py      # Python parser
│   └── visualize_*.py      # Visualization scripts
├── scripts/                # Utility scripts
├── android_app/            # Android converter app
├── apk_analysis/           # APK extraction tools
├── docs/                   # Technical documentation
├── output/                 # Generated files (gitignored)
└── input/                 # Test data (gitignored)
```

## Technical Details

### Calibration Formulas

Raw values from the CAN bus are converted using these formulas:

```python
rpm = raw / 2.56                              # RPM
speed = (raw / 64.0) * 3.6                    # km/h
throttle = ((raw / 8.192) * 100) / 84.96      # %
lean = (raw / 100.0) - 90.0                   # degrees
pitch = (raw / 100.0) - 300.0                 # °/s
brake = raw / 32.0                            # bar
temp = (raw / 1.6) - 30.0                     # °C
accel = (raw / 1000.0) - 7.0                  # G
fuel = raw / 100.0                            # cc
```

### File Format

See `docs/CTRK_FORMAT_SPECIFICATION.md` for complete documentation of the binary format.

## License

MIT License

## Acknowledgments

- File format reverse-engineered from the official Y-Trac application
- Calibration formulas verified using radare2 disassembly of the native library
